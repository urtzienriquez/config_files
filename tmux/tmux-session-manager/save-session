#!/usr/bin/env bash
set -euo pipefail

session="${1:-}"
[[ -z "$session" ]] && { echo "Usage: save-session <session-name>"; exit 1; }

resurrect_dir="$HOME/.local/share/tmux/resurrect"
saved_dir="$resurrect_dir/saved"
mkdir -p "$saved_dir"

# Trigger save
tmux run-shell "$HOME/.config/tmux/plugins/tmux-resurrect/scripts/save.sh"
sleep 0.2

# Filter only this session
awk -v sname="$session" '
  $1=="state" { print; next }
  $2==sname { print }
' "$resurrect_dir/last" > "$saved_dir/$session.resurrect"

# Clean up the most recent .txt backup file created by save.sh
latest_txt=$(ls -t "$resurrect_dir"/tmux_resurrect_*.txt 2>/dev/null | head -n 1)
[ -n "$latest_txt" ] && rm -f "$latest_txt"

echo "Saved session '$session' -> $saved_dir/$session.resurrect"
