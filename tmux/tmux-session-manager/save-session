#!/usr/bin/env bash
set -euo pipefail

session="${1:-}"
[[ -z "$session" ]] && { echo "Usage: save-session <session-name>"; exit 1; }

resurrect_dir="$HOME/.local/share/tmux/resurrect"
saved_dir="$resurrect_dir/saved"
mkdir -p "$saved_dir"

# Trigger tmux-resurrect save
tmux run-shell "$HOME/.config/tmux/plugins/tmux-resurrect/scripts/save.sh" || true

sleep 0.3

if [[ ! -f "$resurrect_dir/last" ]]; then
  echo "Error: tmux-resurrect did not generate a 'last' file."
  exit 1
fi

# Extract session-specific data and save it
awk -v sname="$session" '
  $1 == "state" { print; next }
  $2 == sname { print }
' "$resurrect_dir/last" > "$saved_dir/$session.resurrect"

echo "Saved session '$session' -> $saved_dir/$session.resurrect"

# Clean up old resurrect files, but preserve the one that 'last' points to
shopt -s nullglob
txt_files=("$resurrect_dir"/tmux_resurrect_*.txt)
shopt -u nullglob

# Get the target of the 'last' symlink
last_target=""
if [[ -L "$resurrect_dir/last" ]]; then
  last_target=$(readlink -f "$resurrect_dir/last" 2>/dev/null || true)
fi

# Remove old files, but keep the one that 'last' points to
for f in "${txt_files[@]}"; do
  if [[ -n "$last_target" && "$f" == "$last_target" ]]; then
    # Keep this file - it's what 'last' points to
    continue
  fi
  rm -f -- "$f" || true
done
