#!/usr/bin/env bash
set -euo pipefail

session="${1:-}"
[[ -z "$session" ]] && { echo "Usage: save-session <session-name>"; exit 1; }

# Get resurrect directory
resurrect_dir_config=$(tmux show-option -gv @resurrect-dir 2>/dev/null || echo "NOT_SET")
if [[ "$resurrect_dir_config" != "NOT_SET" ]]; then
    resurrect_dir="$resurrect_dir_config"
else
    resurrect_dir="$HOME/.local/share/tmux/resurrect"
fi

saved_dir="$resurrect_dir/saved"
mkdir -p "$saved_dir"

# Get list of existing files BEFORE save
shopt -s nullglob
old_files=("$resurrect_dir"/tmux_resurrect_*.txt)
shopt -u nullglob

echo "Files before save: ${#old_files[@]}"

# Trigger tmux-resurrect save
tmux run-shell "$HOME/.config/tmux/plugins/tmux-resurrect/scripts/save.sh"
sleep 1

# Check if 'last' file exists
if [[ ! -f "$resurrect_dir/last" && ! -L "$resurrect_dir/last" ]]; then
    echo "Error: tmux-resurrect did not generate a 'last' file."
    exit 1
fi

# Get the source file to read from
source_file=""
if [[ -f "$resurrect_dir/last" ]]; then
    source_file="$resurrect_dir/last"
elif [[ -L "$resurrect_dir/last" ]]; then
    source_file=$(readlink -f "$resurrect_dir/last" 2>/dev/null || echo "")
    if [[ ! -f "$source_file" ]]; then
        echo "Error: Cannot resolve 'last' symlink"
        exit 1
    fi
fi

# Extract and save session data
awk -v sname="$session" '
  $1 == "state" { print; next }
  $2 == sname { print }
' "$source_file" > "$saved_dir/$session.resurrect"

echo "Saved session '$session' -> $saved_dir/$session.resurrect"

# Get list of files AFTER save
shopt -s nullglob
new_files=("$resurrect_dir"/tmux_resurrect_*.txt)
shopt -u nullglob

echo "Files after save: ${#new_files[@]}"

# Find the newly created file (the one that wasn't there before)
newly_created=""
for new_file in "${new_files[@]}"; do
    is_old=false
    for old_file in "${old_files[@]}"; do
        if [[ "$new_file" == "$old_file" ]]; then
            is_old=true
            break
        fi
    done
    if [[ "$is_old" == false ]]; then
        newly_created="$new_file"
        break
    fi
done

echo "Newly created file: ${newly_created:-NONE}"

# Clean up old files, but NEVER remove the newly created one
for f in "${old_files[@]}"; do
    echo "Removing old file: $f"
    rm -f -- "$f" || true
done

echo "Cleanup complete. Kept: ${newly_created:-the current file}"
