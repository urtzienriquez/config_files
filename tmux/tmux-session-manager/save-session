#!/usr/bin/env bash
set -euo pipefail

session="${1:-}"
[[ -z "$session" ]] && { echo "Usage: save-session <session-name>"; exit 1; }

# Get resurrect directory
resurrect_dir_config=$(tmux show-option -gv @resurrect-dir 2>/dev/null || echo "NOT_SET")
if [[ "$resurrect_dir_config" != "NOT_SET" ]]; then
    resurrect_dir="$resurrect_dir_config"
else
    resurrect_dir="$HOME/.local/share/tmux/resurrect"
fi

saved_dir="$resurrect_dir/saved"
mkdir -p "$saved_dir"

# Get list of existing files BEFORE save (silently)
shopt -s nullglob
old_files=("$resurrect_dir"/tmux_resurrect_*.txt)
shopt -u nullglob

# Trigger tmux-resurrect save (silently)
tmux run-shell "$HOME/.config/tmux/plugins/tmux-resurrect/scripts/save.sh" >/dev/null 2>&1
sleep 1

# Check if 'last' file exists
if [[ ! -f "$resurrect_dir/last" && ! -L "$resurrect_dir/last" ]]; then
    tmux display-message "❌ Error: tmux-resurrect did not generate a 'last' file."
    exit 1
fi

# Get the source file to read from
source_file=""
if [[ -f "$resurrect_dir/last" ]]; then
    source_file="$resurrect_dir/last"
elif [[ -L "$resurrect_dir/last" ]]; then
    source_file=$(readlink -f "$resurrect_dir/last" 2>/dev/null || echo "")
    if [[ ! -f "$source_file" ]]; then
        tmux display-message "❌ Error: Cannot resolve 'last' symlink"
        exit 1
    fi
fi

# Extract and save session data
awk -v sname="$session" '
  $1 == "state" { print; next }
  $2 == sname { print }
' "$source_file" > "$saved_dir/$session.resurrect"

# Clean up old files silently
shopt -s nullglob
new_files=("$resurrect_dir"/tmux_resurrect_*.txt)
shopt -u nullglob

# Find newly created file and clean up old ones
newly_created=""
for new_file in "${new_files[@]}"; do
    is_old=false
    for old_file in "${old_files[@]}"; do
        if [[ "$new_file" == "$old_file" ]]; then
            is_old=true
            break
        fi
    done
    if [[ "$is_old" == false ]]; then
        newly_created="$new_file"
        break
    fi
done

for f in "${old_files[@]}"; do
    rm -f -- "$f" >/dev/null 2>&1 || true
done

# Show success message in popup using bash -c
file_path="$saved_dir/$session.resurrect"
tmux display-popup -E -w 80 -h 10 -T " Session Saved " \
  bash -c "clear; echo ''; echo '  ✅ Session \"$session\" saved successfully!'; echo ''; echo '  📁 Saved to:'; echo '  $file_path'; echo ''; echo '  Press Enter to continue...'; echo ''; read -r"
