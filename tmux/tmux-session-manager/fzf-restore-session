#!/usr/bin/env bash
set -euo pipefail

resurrect_dir="$HOME/.local/share/tmux/resurrect"
saved_dir="$resurrect_dir/saved"

# Enable multi-select with --multi and --bind tab:toggle+down
sessions=$(ls "$saved_dir" | sed 's/\.resurrect$//' | \
  fzf --no-preview --multi --prompt="Restore sessions: " --bind tab:toggle+up)

[[ -z "$sessions" ]] && exit 0

for session in $sessions; do
  file="$saved_dir/$session.resurrect"
  [[ -f "$file" ]] || { echo "No saved session: $session"; continue; }

  cp "$file" "$resurrect_dir/last"

  # Create the session if it doesn't exist
  if ! tmux has-session -t "$session" 2>/dev/null; then
    tmux new-session -ds "$session"
  fi

  # Kill existing windows so restore works properly
  tmux list-windows -t "$session" -F "#{window_index}" | while read -r win; do
    tmux kill-window -t "${session}:${win}"
  done

  # Restore session contents
  tmux run-shell -b "$HOME/.config/tmux/plugins/tmux-resurrect/scripts/restore.sh"

  # (Optional) Give tmux some time to finish before restoring the next one
  sleep 0.3
done

# Attach to the last selected session
last_session=$(echo "$sessions" | tail -n 1)
tmux switch-client -t "$last_session"
