# -------------------------------
# Git prompt function
# -------------------------------
autoload -Uz vcs_info
precmd_vcs_info() { vcs_info }
precmd_functions+=( precmd_vcs_info )
setopt prompt_subst

# Configure vcs_info for git
zstyle ':vcs_info:*' enable git
zstyle ':vcs_info:*' check-for-changes true
zstyle ':vcs_info:*' get-unapplied true
# We'll handle the indicators via hooks, so set these empty
zstyle ':vcs_info:*' stagedstr ''
zstyle ':vcs_info:*' unstagedstr ''
zstyle ':vcs_info:git:*' formats ' %F{magenta} %b%f%m'
zstyle ':vcs_info:git:*' actionformats ' %F{magenta} %b%f%F{yellow}|%a%f%m'

# Enable git hooks
zstyle ':vcs_info:git*+set-message:*' hooks git-stats git-behind-ahead

# Hook function to get git diff stats (staged, unstaged, untracked)
+vi-git-stats() {
    if [[ $(git rev-parse --is-inside-work-tree 2>/dev/null) != 'true' ]]; then
        return
    fi

    local added removed staged unstaged untracked stats_str

    # Get diff stats for staged changes
    staged=0
    unstaged=0
    while IFS=$'\t' read -r add del file; do
        unstaged=$((unstaged + add + del))
    done < <(git diff --numstat 2>/dev/null)

    while IFS=$'\t' read -r add del file; do
        staged=$((staged + add + del))
    done < <(git diff --cached --numstat 2>/dev/null)

    # Count untracked files
    untracked=$(git status --porcelain 2>/dev/null | grep -c '^??')

    # Build stats string
    stats_str=""
    if [[ $staged -gt 0 ]]; then
    fi
    if [[ $unstaged -gt 0 ]]; then
        stats_str="${stats_str} %F{red}-${unstaged}%f"
    fi
    if [[ $untracked -gt 0 ]]; then
        stats_str="${stats_str} %F{white}?${untracked}%f"
    fi

    hook_com[misc]="$stats_str"
}

# Hook function to check ahead/behind remote
+vi-git-behind-ahead() {
    local behind ahead
    behind=$(git rev-list HEAD..@{upstream} 2>/dev/null | wc -l)
    ahead=$(git rev-list @{upstream}..HEAD 2>/dev/null | wc -l)
    local arrow_str=""
    [[ $behind -gt 0 ]] && arrow_str="%F{yellow}↓${behind}%f"
    [[ $ahead -gt 0 ]] && arrow_str="${arrow_str} %F{blue}↑${ahead}%f"

    hook_com[misc]="${arrow_str} ${hook_com[misc]}"
}


# Auto-fetch when entering a git repo
chpwd_git_fetch() {
    if git rev-parse --is-inside-work-tree > /dev/null 2>&1; then
        {
            git fetch --quiet 2>/dev/null
            vcs_info
            if (( $+widgets[zle-line-init] )); then
                zle -R
            fi
        } &!
    fi
}
chpwd_functions+=( chpwd_git_fetch )

# -------------------------------
# Vi mode indicator
# -------------------------------
function zle-line-init zle-keymap-select {
    VI_MODE_SYMBOL="${${KEYMAP/vicmd/}/(main|viins)/}"
    zle reset-prompt
}
zle -N zle-line-init
zle -N zle-keymap-select

# -------------------------------
# Custom prompt
# -------------------------------
# Basic two-line prompt with user@host, directory, and git info
PROMPT='%F{magenta}%n@%m%f %F{cyan}%~%f${vcs_info_msg_0_}
%F{%(?.green.red)}${VI_MODE_SYMBOL}%f '
