# -------------------------------
# Git prompt function
# -------------------------------
autoload -Uz vcs_info
precmd_vcs_info() { vcs_info }
precmd_functions+=( precmd_vcs_info )
setopt prompt_subst

# Configure vcs_info for git
zstyle ':vcs_info:*' enable git
zstyle ':vcs_info:*' check-for-changes true
zstyle ':vcs_info:*' get-unapplied true
# We'll handle the indicators via hooks, so set these empty
zstyle ':vcs_info:*' stagedstr ''
zstyle ':vcs_info:*' unstagedstr ''
zstyle ':vcs_info:git:*' formats ' %F{magenta} %b%f%m'
zstyle ':vcs_info:git:*' actionformats ' %F{magenta} %b%f%F{yellow}|%a%f%m'

# Enable git hooks
zstyle ':vcs_info:git*+set-message:*' hooks git-stats git-behind

# Hook function to get git diff stats (like Neovim statusline)
+vi-git-stats() {
    if [[ $(git rev-parse --is-inside-work-tree 2>/dev/null) != 'true' ]]; then
        return
    fi

    local stats_output added removed total untracked stats_str

    # Get diff stats for tracked files
    stats_output=$(git diff --numstat HEAD 2>/dev/null)
    added=0
    removed=0
    
    if [[ -n "$stats_output" ]]; then
        while IFS=$'\t' read -r add del file; do
            added=$((added + add))
            removed=$((removed + del))
        done <<< "$stats_output"
    fi

    total=$((added + removed))
    
    # Check for untracked files
    untracked=$(git status --porcelain 2>/dev/null | grep -c '^??')
    
    # Build the stats string (matching Neovim statusline format)
    stats_str=""
    
    if [[ $added -gt 0 ]]; then
        stats_str="${stats_str} %F{green}+${added}%f"
    fi
    
    if [[ $total -gt 0 ]]; then
        stats_str="${stats_str} %F{blue}~${total}%f"
    fi
    
    if [[ $removed -gt 0 ]]; then
        stats_str="${stats_str} %F{red}-${removed}%f"
    fi
    
    if [[ $untracked -gt 0 ]]; then
        stats_str="${stats_str} %F{white}+${untracked}?%f"
    fi
    
    hook_com[misc]="$stats_str"
}

# Hook function to check if behind origin
+vi-git-behind() {
    local behind
    behind=$(git rev-list HEAD..@{upstream} 2>/dev/null | wc -l)
    if [[ $behind -gt 0 ]]; then
        hook_com[misc]="${hook_com[misc]} %F{yellow}↓${behind}%f"
    fi
}

# Auto-fetch when entering a git repo
chpwd_git_fetch() {
    if git rev-parse --is-inside-work-tree > /dev/null 2>&1; then
        {
            git fetch --quiet 2>/dev/null
            vcs_info
            if (( $+widgets[zle-line-init] )); then
                zle -R
            fi
        } &!
    fi
}
chpwd_functions+=( chpwd_git_fetch )

# -------------------------------
# Vi mode indicator
# -------------------------------
function zle-line-init zle-keymap-select {
    VI_MODE_SYMBOL="${${KEYMAP/vicmd/}/(main|viins)/}"
    zle reset-prompt
}
zle -N zle-line-init
zle -N zle-keymap-select

# -------------------------------
# Custom prompt
# -------------------------------
# Basic two-line prompt with user@host, directory, and git info
PROMPT='%F{magenta}%n@%m%f %F{cyan}%~%f${vcs_info_msg_0_}
%F{%(?.green.red)}${VI_MODE_SYMBOL}%f '
